<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç²µèªè©å½™ç™¼éŸ³æŒ‡å—</title>
    <meta name="referrer" content="no-referrer">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f4f7f9; }
        
        .writing-container {
            width: 340px; 
            height: 340px; 
            position: relative;
            background-color: #fff;
            border: 3px dashed #d1d5db;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 10px;
            cursor: crosshair;
        }

        .char-tab {
            width: 45px; height: 45px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; font-weight: bold;
            border-radius: 8px; cursor: pointer; transition: all 0.2s;
            border: 2px solid #e5e7eb; background-color: white; color: #374151;
        }
        .char-tab.active {
            background-color: #3b82f6; color: white;
            border-color: #2563eb; transform: scale(1.1);
        }

        #score-display {
            font-weight: bold;
            text-align: center;
            margin-top: 8px;
            min-height: 28px;
            font-size: 1.1rem;
        }
        .score-good { color: #10b981; } 
        .score-ok { color: #f59e0b; }
        .score-bad { color: #ef4444; } 
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <div id="app" class="w-full max-w-4xl bg-white shadow-2xl rounded-xl p-6 md:p-10 relative z-10">
        <h1 id="header-title" class="text-3xl font-bold text-gray-800 text-center mb-6">ç²µèªè©å½™ç™¼éŸ³ç³»çµ±</h1>
        
        <div id="breadcrumb" class="text-sm text-gray-500 mb-6 flex space-x-2 items-center">
            <span class="cursor-pointer hover:text-blue-600 transition duration-150" onclick="renderHome()">ä¸»é </span>
            <span id="breadcrumb-book" class="hidden">/ <span class="font-medium text-gray-600 transition duration-150"></span></span>
            <span id="breadcrumb-lesson" class="hidden">/ <span class="font-medium text-gray-800 transition duration-150"></span></span>
        </div>

        <div id="browser-tts-info" class="p-3 bg-blue-100 text-blue-700 rounded-lg border border-blue-400 mt-2 mb-6 text-sm">
            ğŸ“¢ <b>Google èªéŸ³</b>å·²å•Ÿç”¨ã€‚é»æ“Šã€Œå¯«å­—ã€å¯é€²è¡Œ<b>å½¢ç‹€ç›¸ä¼¼åº¦</b>ç·´ç¿’ (è©•åˆ†å·²å„ªåŒ–)ã€‚
        </div>
        
        <div id="content"></div>
    </div>

    <div id="writing-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden z-50 flex items-center justify-center p-2">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-4 flex flex-col items-center relative">
            <div class="w-full flex justify-between items-center mb-2 border-b pb-2">
                <h3 class="text-xl font-bold text-gray-700">å¯«å­—ç·´ç¿’</h3>
                <button onclick="closeWritingModal()" class="text-gray-400 hover:text-red-500 text-2xl font-bold">&times;</button>
            </div>
            
            <div id="char-tabs-container" class="flex space-x-2 mb-2 overflow-x-auto py-2 w-full justify-center"></div>
            
            <div class="writing-container relative">
                <div id="hanzi-target" class="absolute inset-0 z-0 pointer-events-none"></div>
                <canvas id="writing-canvas" width="340" height="340" class="absolute inset-0 z-10"></canvas>
            </div>

            <div id="score-display" class="text-gray-500">è«‹åœ¨ç°è‰²å­—ä¸Šæå¯«...</div>

            <div class="grid grid-cols-2 gap-3 mt-4 w-full">
                <button onclick="checkSimilarity()" class="py-3 bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-lg shadow transition flex justify-center items-center">
                    ğŸ’¯ æª¢æŸ¥è©•åˆ†
                </button>
                <button onclick="animateChar()" class="py-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-lg shadow transition flex justify-center items-center">
                    ğŸ‘€ è§€çœ‹å¯«æ³•
                </button>
            </div>

            <div class="grid grid-cols-2 gap-3 mt-2 w-full">
                <button onclick="clearCanvas()" class="py-2 bg-yellow-400 hover:bg-yellow-500 text-white font-bold rounded-lg shadow transition">
                    ğŸ§¹ æ¸…é™¤
                </button>
                <button onclick="closeWritingModal()" class="py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold rounded-lg transition">
                    é—œé–‰
                </button>
            </div>

            <button id="next-char-btn" onclick="nextChar()" class="mt-3 w-full py-2 bg-blue-100 hover:bg-blue-200 text-blue-700 font-bold rounded-lg transition hidden">
                ä¸‹ä¸€å€‹å­— â¡
            </button>
        </div>
    </div>

    <canvas id="target-canvas" width="340" height="340" class="hidden"></canvas>

    <div id="definition-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 flex flex-col relative">
            <div class="border-b pb-3 mb-4 flex justify-between items-start">
                <div><h3 id="def-modal-title" class="text-3xl font-bold text-gray-800"></h3><p id="def-modal-jyutping" class="text-gray-500 text-sm mt-1"></p></div>
                <button onclick="closeDefinitionModal()" class="text-gray-400 hover:text-red-500 text-2xl font-bold">&times;</button>
            </div>
            <div class="mb-4"><h4 class="text-xs font-bold text-gray-400 uppercase tracking-wide mb-1">ä¸­æ–‡è§£é‡‹</h4><p id="def-modal-zh" class="text-lg text-gray-800 font-medium leading-relaxed"></p></div>
            <div id="def-en-container" class="hidden mb-4 p-3 bg-gray-50 rounded-lg border border-gray-100"><h4 class="text-xs font-bold text-gray-400 uppercase tracking-wide mb-1">English Meaning</h4><p id="def-modal-en" class="text-md text-gray-700 font-medium leading-relaxed"></p></div>
            <button id="btn-show-english" onclick="showEnglishDefinition()" class="w-full py-2 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 font-semibold rounded-lg transition mb-3">ğŸ‘€ é¡¯ç¤ºè‹±æ–‡è§£é‡‹</button>
            <button onclick="closeDefinitionModal()" class="w-full py-2 bg-gray-100 hover:bg-gray-200 text-gray-600 font-semibold rounded-lg transition">é—œé–‰</button>
        </div>
    </div>

<script type="module">
    const speechSpeed = 0.9; 

    // --- è³‡æ–™è¨­å®šå€ (å·²æ›´æ–°ç¬¬å…­èª²è§£é‡‹) ---
    const learningMaterial = {
        1: { 
            title: "ç¬¬ä¸€å†Š",
            lessons: [
                { id: 1, title: "ç¬¬ä¸€èª²", words: [ 
                    { text: "æˆ‘", jyutping: "ngo5", meaningZH: "ç¬¬ä¸€äººç¨±ä»£è©ï¼ŒæŒ‡è‡ªå·±ã€‚", meaningEN: "I; me" }, 
                    { text: "ä½ å¥½", jyutping: "nei5 hou2", meaningZH: "è¦‹é¢æ™‚çš„å•å€™èªã€‚", meaningEN: "Hello; Hi" },
                    { text: "å†è¦‹", jyutping: "zoi3 gin3", meaningZH: "åˆ†åˆ¥æ™‚çš„é“åˆ¥èªã€‚", meaningEN: "Goodbye" }
                ] },
                { id: 2, title: "ç¬¬äºŒèª²", words: [ 
                    { text: "ä¸€", jyutping: "jat1" }, { text: "äºŒ", jyutping: "ji6" }, { text: "ä¸‰", jyutping: "saam1" }, 
                    { text: "å››", jyutping: "sei3" }, { text: "äº”", jyutping: "ng5" }, { text: "å…­", jyutping: "luk6" }, 
                    { text: "ä¸ƒ", jyutping: "cat1" }, { text: "å…«", jyutping: "baat3" }, { text: "ä¹", jyutping: "gau2" }, 
                    { text: "å", jyutping: "sap6" }
                ] },
                { id: 3, title: "ç¬¬ä¸‰èª² (å¤šéŸ³å­—æ¸¬è©¦)", words: [
                    { text: "è¡Œ (è¡Œèµ°)", jyutping: "haang4", speakText: "æ­", meaningZH: "èµ°è·¯ï¼Œæ­¥è¡Œã€‚", meaningEN: "To walk" },
                    { text: "è¡Œ (éŠ€è¡Œ)", jyutping: "hong4", speakText: "æ­", meaningZH: "è™•ç†é‡‘èæ¥­å‹™çš„æ©Ÿæ§‹ã€‚", meaningEN: "Bank" }
                ] }
            ]
        },
        2: {
            title: "ç¬¬äºŒå†Š",
            lessons: [
                { id: 4, title: "ç¬¬å››èª²", words:[
                    {text: "åŒ—äº¬", jyutping: "bak1 ging1"}, {text: "å¤šé›²", jyutping: "do1 wan4"}, {text: "æœ‰éœ§", jyutping: "jau5 mou6"},
                    {text: "é™°å¤©", jyutping: "jam1 tin1"}, {text: "é¢±é¢¨", jyutping: "toi4 fung1"}, {text: "è¥¿å®‰", jyutping: "sai1 on1"}
                ] },
                { id: 5, title: "ç¬¬äº”èª²", words: [
                    { text: "è¦ºå¾—", jyutping: "gok3 dak1", meaningZH: "èªç‚ºï¼›æ„Ÿåˆ°ã€‚", meaningEN: "To feel; to think" }, 
                    { text: "èˆ’æœ", jyutping: "syu1 fuk6", meaningZH: "èº«å¿ƒæ„Ÿåˆ°è¼•é¬†æ„‰å¿«ã€‚", meaningEN: "Comfortable" }, 
                    { text: "ç™¼ç‡’", jyutping: "faat3 siu1", speakText: "ç™¼å®µ", meaningZH: "é«”æº«ç•°å¸¸å‡é«˜ï¼Œé€šå¸¸æ˜¯ç”Ÿç—…çš„å¾µå…†ã€‚", meaningEN: "Fever" },
                    { text: "é ­ç—›", jyutping: "tau4 tung3", meaningZH: "é ­éƒ¨ç–¼ç—›ã€‚", meaningEN: "Headache" }, 
                    { text: "å–‰åš¨ç—›", jyutping: "hau4 lung4 tung3", meaningZH: "å’½å–‰éƒ¨ä½ç–¼ç—›ã€‚", meaningEN: "Sore throat" }, 
                    { text: "è‚šç€‰", jyutping: "tou5 se3", meaningZH: "è…¹ç€‰ï¼Œæ‹‰è‚šå­ã€‚", meaningEN: "Diarrhea" }, 
                    { text: "é†«é™¢", jyutping: "ji1 jyun2", meaningZH: "æ²»ç™‚ç—…äººçš„æ©Ÿæ§‹ã€‚", meaningEN: "Hospital" }, 
                    { text: "è­·å£«", jyutping: "wu6 si6", meaningZH: "è² è²¬è­·ç†ç—…äººçš„äººå“¡ã€‚", meaningEN: "Nurse" }, 
                    { text: "è¨ºæ–·", jyutping: "can2 dyun6", meaningZH: "é†«ç”Ÿåˆ¤æ–·ç—…äººçš„ç—…æƒ…ã€‚", meaningEN: "Diagnosis" }, 
                    { text: "æ„Ÿå†’", jyutping: "gam2 mo6", meaningZH: "ä¸Šå‘¼å¸é“æ„ŸæŸ“ã€‚", meaningEN: "Cold; Flu" }, 
                    { text: "è—¥", jyutping: "joek6", meaningZH: "æ²»ç™‚ç–¾ç—…çš„ç‰©è³ªã€‚", meaningEN: "Medicine" },
                    { text: "ç”Ÿç—…", jyutping: "saang1 beng6", meaningZH: "èº«é«”ä¸èˆ’æœï¼Œæ‚£ç—…ã€‚", meaningEN: "Sick" },
                    { text: "æµé¼»æ¶•", jyutping: "lau4 bei6 tai3", meaningZH: "é¼»è…”æµå‡ºæ¶²é«”ã€‚", meaningEN: "Runny nose" },
                    { text: "åº·å¾©", jyutping: "hong1 fuk6", meaningZH: "æ¢å¾©å¥åº·ã€‚", meaningEN: "Recover" },
                    { text: "å¥åº·", jyutping: "gin1 hong1", meaningZH: "èº«é«”å¥½ï¼Œæ²’æœ‰ç”Ÿç—…ã€‚", meaningEN: "Health" }
                ] },
                { id: 6, title: "ç¬¬å…­èª²", words: [
                    { text: "é¤Š", jyutping: "joung5", meaningZH: "é£¼é¤Šï¼›ç…§é¡§å‹•ç‰©ã€‚", meaningEN: "To raise; to keep (a pet)" }, 
                    { text: "å››æ­²", jyutping: "sei3 seoi3", meaningZH: "å¹´é½¡æ˜¯å››æ­²ã€‚", meaningEN: "Four years old" }, 
                    { text: "è°æ˜", jyutping: "cung1 ming4", meaningZH: "å¤©è³‡é«˜ï¼Œå­¸ç¿’èƒ½åŠ›å¼·ã€‚", meaningEN: "Smart; clever" },
                    { text: "å¯æ„›", jyutping: "ho2 oi3", meaningZH: "ä»¤äººå–œæ„›ã€‚", meaningEN: "Cute; lovely" }, 
                    { text: "æ£•è‰²", jyutping: "zung1 sik1", meaningZH: "åƒæ¨¹å¹¹æˆ–å’–å•¡çš„é¡è‰²ã€‚", meaningEN: "Brown" }, 
                    { text: "äº®æ™¶æ™¶", jyutping: "loeng6 zing1 zing1", meaningZH: "é–ƒäº®è€€çœ¼çš„æ¨£å­ã€‚", meaningEN: "Sparkling; shiny" },
                    { text: "ç˜¦å°", jyutping: "sau3 siu2", meaningZH: "èº«æç˜¦å¼±çŸ®å°ã€‚", meaningEN: "Thin and small" }, 
                    { text: "æ´»æ½‘", jyutping: "wut6 put3", meaningZH: "ç”Ÿå‹•è‡ªç„¶ï¼Œä¸å‘†æ¿ã€‚", meaningEN: "Lively; active" }, 
                    { text: "å¥½å‹•", jyutping: "hou3 dung6", speakText: "æ†å‹•", meaningZH: "å–œæ­¡æ´»å‹•ï¼Œä¸æ„›éœåã€‚", meaningEN: "Active; energetic" },
                    { text: "é¤µ", jyutping: "wai3", meaningZH: "çµ¦å‹•ç‰©æˆ–äººåƒæ±è¥¿ã€‚", meaningEN: "To feed" }, 
                    { text: "å˜ˆåµ", jyutping: "cou4 caau2", meaningZH: "è²éŸ³é›œäº‚åˆºè€³ã€‚", meaningEN: "Noisy" }
                ] },
                { id: 7, title: "ç¬¬ä¸ƒèª²", words: [{ text: "çˆ¸çˆ¸", jyutping: "baa1 baa1" }] },
                { id: 8, title: "ç¬¬å…«èª²", words: [{ text: "ä¸€äºŒä¸‰", jyutping: "yat1 yi6 saam1" }] },
                { id: 9, title: "ç¬¬ä¹èª²", words: [{ text: "å¥½é£Ÿ", jyutping: "hou2 sik6" }] },
                { id: 10, title: "ç¬¬åèª²", words: [{ text: "é¦™æ¸¯", jyutping: "hoeng1 gong2" }] }
            ]
        },
        3: { title: "ç¬¬ä¸‰å†Š", lessons: Array.from({ length: 5 }, (_, i) => ({ id: i + 1, title: `ç¬¬${i + 1}èª²`, words: [ { text: `å•†æ¥­ç”¨èª`, jyutping: "soeng1 yip6" } ] })) },
        4: { title: "ç¬¬å››å†Š", lessons: Array.from({ length: 5 }, (_, i) => ({ id: i + 1, title: `ç¬¬${i + 1}èª²`, words: [ { text: `å£èªè¡¨é”`, jyutping: "hau2 yu5" } ] })) }
    };
    
    // --- æ ¸å¿ƒè®Šæ•¸ ---
    let currentView = 'home';
    let selectedBook = null;
    let selectedLesson = null;
    const contentDiv = document.getElementById('content');
    const headerTitle = document.getElementById('header-title');
    const breadcrumbBook = document.getElementById('breadcrumb-book');
    const breadcrumbLesson = document.getElementById('breadcrumb-lesson');
    let currentAudio = null;

    function speakCantonese(text) {
        if (currentAudio) { currentAudio.pause(); currentAudio.currentTime = 0; }
        const encodedText = encodeURIComponent(text);
        const url = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodedText}&tl=zh-yue&total=1&idx=0&textlen=${text.length}&client=tw-ob&prev=input&ttsspeed=1`;
        currentAudio = new Audio(url);
        currentAudio.playbackRate = speechSpeed; 
        currentAudio.onerror = function() { alert("æ’­æ”¾å¤±æ•—ã€‚è«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥ã€‚"); };
        currentAudio.play().catch(e => console.error(e));
    }
    window.handlePronunciationRequest = function(text, jyutping, speakText) { speakCantonese(speakText ? speakText : text); }

    // --- Definition Logic ---
    const defModal = document.getElementById('definition-modal');
    const defTitle = document.getElementById('def-modal-title');
    const defJyutping = document.getElementById('def-modal-jyutping');
    const defZH = document.getElementById('def-modal-zh');
    const defEN = document.getElementById('def-modal-en');
    const defEnContainer = document.getElementById('def-en-container');
    const btnShowEnglish = document.getElementById('btn-show-english');
    window.openDefinitionModal = function(text, jyutping, zh, en) {
        defTitle.innerText = text; defJyutping.innerText = jyutping;
        defZH.innerText = zh && zh !== 'undefined' ? zh : "æš«ç„¡ä¸­æ–‡è§£é‡‹";
        defEN.innerText = en && en !== 'undefined' ? en : "No English definition available.";
        defEnContainer.classList.add('hidden');
        if (en && en !== 'undefined') btnShowEnglish.classList.remove('hidden'); else btnShowEnglish.classList.add('hidden');
        defModal.classList.remove('hidden');
    }
    window.showEnglishDefinition = function() { defEnContainer.classList.remove('hidden'); btnShowEnglish.classList.add('hidden'); }
    window.closeDefinitionModal = function() { defModal.classList.add('hidden'); }

    // --- Writing & Similarity Logic (Optimized for NCS) ---
    const writingModal = document.getElementById('writing-modal');
    const charTabsContainer = document.getElementById('char-tabs-container');
    const nextCharBtn = document.getElementById('next-char-btn');
    const scoreDisplay = document.getElementById('score-display');
    const canvas = document.getElementById('writing-canvas');
    const ctx = canvas.getContext('2d');
    const targetCanvas = document.getElementById('target-canvas');
    const targetCtx = targetCanvas.getContext('2d');
    
    let hanziWriterInstance = null;
    let currentWordArr = [];
    let currentCharIndex = 0;
    let isDrawing = false;
    let currentCharacter = "";

    // æ‚¨ä¿®æ”¹éçš„åƒæ•¸ (ç¶­æŒæ‚¨çš„è¨­å®š)
    ctx.lineWidth = 12; 
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.strokeStyle = '#2563eb'; 

    window.openWritingModal = function(text) {
        writingModal.classList.remove('hidden');
        const cleanText = text.split(' ')[0]; 
        currentWordArr = cleanText.split(''); 
        renderCharTabs();
        selectChar(0);
    }

    function renderCharTabs() {
        charTabsContainer.innerHTML = '';
        currentWordArr.forEach((char, index) => {
            const btn = document.createElement('div');
            btn.className = `char-tab ${index === currentCharIndex ? 'active' : ''}`;
            btn.innerText = char;
            btn.onclick = () => selectChar(index);
            charTabsContainer.appendChild(btn);
        });
    }

    window.selectChar = function(index) {
        currentCharIndex = index;
        currentCharacter = currentWordArr[index];
        
        const tabs = document.querySelectorAll('.char-tab');
        tabs.forEach((tab, i) => { if(i === index) tab.classList.add('active'); else tab.classList.remove('active'); });
        if (index < currentWordArr.length - 1) nextCharBtn.classList.remove('hidden'); else nextCharBtn.classList.add('hidden');

        clearCanvas();
        scoreDisplay.innerText = "è«‹åœ¨ç°è‰²å­—ä¸Šæå¯«...";
        scoreDisplay.className = "text-gray-500";
        document.getElementById('hanzi-target').innerHTML = '';

        hanziWriterInstance = HanziWriter.create('hanzi-target', currentCharacter, {
            width: 340, height: 340, padding: 20, 
            showOutline: true, 
            showCharacter: false,
            // ä½¿ç”¨æ·±ç°è‰²ï¼Œè®“å­¸ç”Ÿçœ‹å¾—æ¸…æ¥š
            strokeColor: '#9ca3af', 
        });

        // ç¹ªè£½ç›®æ¨™å­— (å¾Œå°æ¯”å°ç”¨)
        targetCtx.clearRect(0, 0, 340, 340);
        targetCtx.font = "bold 260px 'Noto Sans TC', sans-serif";
        targetCtx.textAlign = "center";
        targetCtx.textBaseline = "middle";
        targetCtx.fillStyle = "black";
        targetCtx.fillText(currentCharacter, 170, 185);
    }

    // â˜…â˜…â˜… å„ªåŒ–é» 3ï¼šå¯¬å®¹è©•åˆ†æ¼”ç®—æ³• â˜…â˜…â˜…
    window.checkSimilarity = function() {
        const studentData = ctx.getImageData(0, 0, 340, 340).data;
        const targetData = targetCtx.getImageData(0, 0, 340, 340).data;
        
        let targetPixels = 0;
        let overlapPixels = 0;
        let errorPixels = 0;

        for (let i = 0; i < targetData.length; i += 4) {
            const isTargetInk = targetData[i + 3] > 100;
            const isStudentInk = studentData[i + 3] > 100;

            if (isTargetInk) {
                targetPixels++;
                if (isStudentInk) overlapPixels++;
            } else {
                if (isStudentInk) errorPixels++;
            }
        }

        if (targetPixels === 0) return;

        // åŸå§‹è¦†è“‹ç‡
        const rawCoverage = overlapPixels / targetPixels;
        
        // â˜…â˜…â˜… é—œéµä¿®æ”¹ï¼šåˆ†æ•¸å€å¢å™¨ (Difficulty Multiplier) â˜…â˜…â˜…
        const difficultyMultiplier = 2; 
        
        // è¨ˆç®—åŸºç¤åˆ†
        let score = (rawCoverage * difficultyMultiplier) * 100;
        
        // æ‰£åˆ†æ©Ÿåˆ¶
        const penalty = (errorPixels / targetPixels) * 10;
        
        score = score - penalty;

        if (score > 100) score = 100;
        if (score < 0) score = 0;
        
        displayScore(Math.round(score));
    }

    function displayScore(score) {
        if (score >= 80) {
            scoreDisplay.innerHTML = `ğŸŒŸ <span class="score-good">å®Œç¾ï¼ç›¸ä¼¼åº¦ ${score}%</span> (å¤ªæ£’äº†)`;
        } else if (score >= 40) { 
            scoreDisplay.innerHTML = `âœ… <span class="score-good">åŠæ ¼ï¼ç›¸ä¼¼åº¦ ${score}%</span> (å¾ˆå¥½)`;
        } else if (score >= 10) {
            scoreDisplay.innerHTML = `ğŸ’ª <span class="score-ok">ç›¸ä¼¼åº¦ ${score}%</span> (å†å¤šå¯«ä¸€é»)`;
        } else {
            scoreDisplay.innerHTML = `<span class="score-bad">è«‹è©¦è‘—å¡«æ»¿ç°è‰²å€åŸŸ</span>`;
        }
    }

    window.animateChar = function() {
        if(!hanziWriterInstance) return;
        clearCanvas();
        hanziWriterInstance.showCharacter(); 
        hanziWriterInstance.animateCharacter();
    }
    window.nextChar = function() { if (currentCharIndex < currentWordArr.length - 1) selectChar(currentCharIndex + 1); }
    window.closeWritingModal = function() { writingModal.classList.add('hidden'); }
    window.clearCanvas = function() { 
        ctx.clearRect(0, 0, canvas.width, canvas.height); 
        scoreDisplay.innerText = "è«‹åœ¨ç°è‰²å­—ä¸Šæå¯«...";
        scoreDisplay.className = "text-gray-500";
        if(hanziWriterInstance) hanziWriterInstance.hideCharacter();
    }

    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
    }
    function startDraw(e) { isDrawing = true; const pos = getPos(e); ctx.beginPath(); ctx.moveTo(pos.x, pos.y); e.preventDefault(); }
    function draw(e) { if (!isDrawing) return; const pos = getPos(e); ctx.lineTo(pos.x, pos.y); ctx.stroke(); e.preventDefault(); }
    function endDraw() { isDrawing = false; ctx.beginPath(); }
    
    canvas.addEventListener('mousedown', startDraw); canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', endDraw); canvas.addEventListener('mouseout', endDraw);
    canvas.addEventListener('touchstart', startDraw, { passive: false });
    canvas.addEventListener('touchmove', draw, { passive: false });
    canvas.addEventListener('touchend', endDraw);

    function renderHome() {
        currentView = 'home'; selectedBook = null; selectedLesson = null;
        headerTitle.textContent = "ç²µèªè©å½™å­¸ç¿’ç³»çµ±";
        breadcrumbBook.classList.add('hidden'); breadcrumbLesson.classList.add('hidden');
        let html = '<div class="grid grid-cols-2 md:grid-cols-4 gap-4">';
        Object.keys(learningMaterial).forEach(bookId => {
            html += `<button onclick="selectBook(${bookId})" class="p-6 bg-blue-500 text-white font-semibold text-lg rounded-lg shadow-md hover:bg-blue-600 transition duration-150 transform hover:scale-105">${learningMaterial[bookId].title}</button>`;
        });
        html += '</div>'; contentDiv.innerHTML = html;
    }
    function renderBook() {
        const book = learningMaterial[selectedBook];
        headerTitle.textContent = `${book.title} - é¸æ“‡èª²å ‚`;
        breadcrumbBook.querySelector('span').textContent = book.title;
        breadcrumbBook.classList.remove('hidden'); breadcrumbLesson.classList.add('hidden');
        let html = '<div class="grid grid-cols-2 md:grid-cols-5 gap-4">';
        book.lessons.forEach(lesson => {
            html += `<button onclick="selectLesson(${lesson.id})" class="p-4 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition duration-150">${lesson.title}</button>`;
        });
        html += '</div>'; contentDiv.innerHTML = html;
    }
    function renderLesson() {
        const book = learningMaterial[selectedBook];
        const lesson = book.lessons.find(l => l.id === selectedLesson);
        headerTitle.textContent = `${book.title} - ${lesson.title}`;
        breadcrumbLesson.querySelector('span').textContent = lesson.title;
        breadcrumbLesson.classList.remove('hidden');
        let html = `<div class="mb-6 flex justify-start"><button onclick="renderBook()" class="flex items-center space-x-2 px-4 py-2 bg-yellow-500 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-600 transition duration-150"><span>â¬… è¿”å›èª²å ‚åˆ—è¡¨</span></button></div><div class="space-y-4">`;
        lesson.words.forEach((item) => {
            html += `<div class="p-4 bg-gray-100 rounded-lg shadow-inner border-l-4 border-red-500 flex flex-col md:flex-row justify-between items-center hover:bg-yellow-50 transition duration-150 gap-4"><div class="flex-1 text-center md:text-left"><div class="text-3xl font-bold text-gray-800">${item.text}</div><div class="text-sm text-gray-500 mt-1">${item.jyutping}</div></div><div class="flex space-x-2"><button onclick="handlePronunciationRequest('${item.text}', '${item.jyutping}', '${item.speakText || ''}')" class="bg-red-500 text-white px-3 py-2 rounded-lg shadow hover:bg-red-600 active:scale-95 transition flex items-center text-sm font-medium">ğŸ”Š <span class="hidden md:inline ml-1">æ’­æ”¾</span></button><button onclick="openWritingModal('${item.text}')" class="bg-blue-500 text-white px-3 py-2 rounded-lg shadow hover:bg-blue-600 active:scale-95 transition flex items-center text-sm font-medium">ğŸ“ <span class="hidden md:inline ml-1">å¯«å­—</span></button><button onclick="openDefinitionModal('${item.text}', '${item.jyutping}', '${item.meaningZH || ''}', '${item.meaningEN ? item.meaningEN.replace(/'/g, "\\'") : ''}')" class="bg-green-500 text-white px-3 py-2 rounded-lg shadow hover:bg-green-600 active:scale-95 transition flex items-center text-sm font-medium">ğŸ“– <span class="hidden md:inline ml-1">è§£é‡‹</span></button></div></div>`;
        });
        html += '</div>'; contentDiv.innerHTML = html;
    }
    window.selectBook = (id) => { selectedBook = id; renderBook(); };
    window.selectLesson = (id) => { selectedLesson = id; renderLesson(); };
    window.renderHome = renderHome; window.renderBook = renderBook;
    window.selectChar = selectChar; window.nextChar = nextChar; 
    window.checkSimilarity = checkSimilarity; window.animateChar = animateChar;
    window.openDefinitionModal = openDefinitionModal; window.showEnglishDefinition = showEnglishDefinition; window.closeDefinitionModal = closeDefinitionModal;
    window.onload = renderHome;
</script>
</body>
</html>

