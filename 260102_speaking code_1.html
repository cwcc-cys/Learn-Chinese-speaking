<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç²µèªè©å½™ç™¼éŸ³æŒ‡å— (å®Œæ•´è©å½™æ›¸å¯«ç‰ˆ)</title>
    <meta name="referrer" content="no-referrer">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f4f7f9; }
        canvas { touch-action: none; }
        
        .writing-container {
            width: 340px; 
            height: 340px; 
            position: relative;
            background-color: #fff;
            border: 3px dashed #d1d5db;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 10px;
        }

        /* å­—å¡åˆ‡æ›æŒ‰éˆ•æ¨£å¼ */
        .char-tab {
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid #e5e7eb;
            background-color: white;
            color: #374151;
        }
        .char-tab.active {
            background-color: #3b82f6; /* è—è‰² */
            color: white;
            border-color: #2563eb;
            transform: scale(1.1);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <div id="app" class="w-full max-w-4xl bg-white shadow-2xl rounded-xl p-6 md:p-10 relative z-10">
        <h1 id="header-title" class="text-3xl font-bold text-gray-800 text-center mb-6">ç²µèªè©å½™ç™¼éŸ³ç³»çµ±</h1>
        
        <div id="breadcrumb" class="text-sm text-gray-500 mb-6 flex space-x-2 items-center">
            <span class="cursor-pointer hover:text-blue-600 transition duration-150" onclick="renderHome()">ä¸»é </span>
            <span id="breadcrumb-book" class="hidden">/ <span class="font-medium text-gray-600 transition duration-150"></span></span>
            <span id="breadcrumb-lesson" class="hidden">/ <span class="font-medium text-gray-800 transition duration-150"></span></span>
        </div>

        <div id="browser-tts-info" class="p-3 bg-blue-100 text-blue-700 rounded-lg border border-blue-400 mt-2 mb-6 text-sm">
            ğŸ“¢ <b>Google èªéŸ³</b>å·²å•Ÿç”¨ã€‚é»æ“Šã€Œå¯«å­—ã€å¯ç·´ç¿’æ•´å€‹è©å½™çš„ç­†é †ã€‚
        </div>
        
        <div id="content"></div>
    </div>

    <div id="writing-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden z-50 flex items-center justify-center p-2">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-4 flex flex-col items-center relative">
            
            <div class="w-full flex justify-between items-center mb-2 border-b pb-2">
                <h3 class="text-xl font-bold text-gray-700">å¯«å­—ç·´ç¿’</h3>
                <button onclick="closeWritingModal()" class="text-gray-400 hover:text-red-500 text-2xl font-bold">&times;</button>
            </div>

            <div id="char-tabs-container" class="flex space-x-2 mb-2 overflow-x-auto py-2 w-full justify-center">
                </div>

            <div class="writing-container relative">
                <div id="hanzi-target" class="absolute inset-0 z-0"></div>
                <canvas id="writing-canvas" width="340" height="340" class="absolute inset-0 z-10 cursor-crosshair"></canvas>
            </div>

            <div class="grid grid-cols-2 gap-3 mt-4 w-full">
                <button onclick="replayAnimation()" class="py-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-lg shadow transition flex justify-center items-center">
                    ğŸ”„ é‡æ’­ç­†é †
                </button>
                <button onclick="clearCanvas()" class="py-3 bg-yellow-400 hover:bg-yellow-500 text-white font-bold rounded-lg shadow transition flex justify-center items-center">
                    ğŸ§¹ æ¸…é™¤ç­†è·¡
                </button>
            </div>

            <button id="next-char-btn" onclick="nextChar()" class="mt-3 w-full py-2 bg-blue-100 hover:bg-blue-200 text-blue-700 font-bold rounded-lg transition hidden">
                ä¸‹ä¸€å€‹å­— â¡
            </button>
            
            <button onclick="closeWritingModal()" class="mt-2 w-full py-2 text-gray-400 hover:text-gray-600 font-medium text-sm">
                é—œé–‰è¦–çª—
            </button>
        </div>
    </div>

<script type="module">
    
    // --- èªé€Ÿè¨­å®š ---
    const speechSpeed = 0.9; 

    // --- è³‡æ–™è¨­å®š ---
    const learningMaterial = {
        1: { 
            title: "ç¬¬ä¸€å†Š",
            lessons: [
                { id: 1, title: "ç¬¬ä¸€èª²", words: [ 
                    { text: "æˆ‘", jyutping: "ngo5" }, { text: "ä½ ", jyutping: "nei5" }, { text: "æ˜¯", jyutping: "si6" },
                    { text: "å¥³", jyutping: "neoi5", speakText: "é¤’" }, 
                    { text: "ä½ å¥½", jyutping: "nei5 hou2" }, { text: "å†è¦‹", jyutping: "zoi3 gin3" }, { text: "è¬è¬", jyutping: "ze6 ze6" } 
                ] },
                { id: 2, title: "ç¬¬äºŒèª²", words: [ 
                    { text: "ä¸€", jyutping: "jat1" }, { text: "äºŒ", jyutping: "ji6" }, { text: "ä¸‰", jyutping: "saam1" }, 
                    { text: "å››", jyutping: "sei3" }, { text: "äº”", jyutping: "ng5" }, { text: "å…­", jyutping: "luk6" }, 
                    { text: "ä¸ƒ", jyutping: "cat1" }, { text: "å…«", jyutping: "baat3" }, { text: "ä¹", jyutping: "gau2" }, 
                    { text: "å", jyutping: "sap6" }
                ] },
                { id: 3, title: "ç¬¬ä¸‰èª² (å¤šéŸ³å­—æ¸¬è©¦)", words: [
                    { text: "è¡Œ (è¡Œèµ°)", jyutping: "haang4", speakText: "æ­" },
                    { text: "è¡Œ (éŠ€è¡Œ)", jyutping: "hong4", speakText: "æ­" }, 
                    { text: "å¿«æ¨‚", jyutping: "faai3 lok6", speakText: "å¿«æ´›" },
                    { text: "éŸ³æ¨‚", jyutping: "jam1 ngok6", speakText: "éŸ³å²³" }
                ] },
                { id: 4, title: "ç¬¬å››èª²", words: [{ text: "å±‹ä¼", jyutping: "uk1 kei2" }] }
            ]
        },
        2: {
            title: "ç¬¬äºŒå†Š",
            lessons: [
                {
                    id: 4, title: "ç¬¬å››èª²", words:[
                    {text: "åŒ—äº¬", jyutping: "bak1 ging1"}, {text: "å¤šé›²", jyutping: "do1 wan4"}, {text: "æœ‰éœ§", jyutping: "jau5 mou6"},
                    {text: "é™°å¤©", jyutping: "jam1 tin1"}, {text: "é¢±é¢¨", jyutping: "toi4 fung1"}, {text: "è¥¿å®‰", jyutping: "sai1 on1"}
                ] },
                { id: 5, title: "ç¬¬äº”èª²", words: [
                    { text: "è¦ºå¾—", jyutping: "gok3 dak1" }, { text: "èˆ’æœ", jyutping: "syu1 fuk6" }, { text: "ç™¼ç‡’", jyutping: "faat3 siu1", speakText: "ç™¼å®µ"},
                    { text: "é ­ç—›", jyutping: "tau4 tung3" }, { text: "å–‰åš¨ç—›", jyutping: "hau4 lung4 tung3" }, { text: "è‚šç€‰", jyutping: "tou5 se3" }, 
                    { text: "é†«é™¢", jyutping: "ji1 jyun2" }, { text: "è­·å£«", jyutping: "wu6 si6" }, { text: "è¨ºæ–·", jyutping: "can2 dyun6" }, 
                    { text: "æ„Ÿå†’", jyutping: "gam2 mo6" }, { text: "è—¥", jyutping: "joek6" }, { text: "ç”Ÿç—…", jyutping: "saang1 beng6" },
                    { text: "æµé¼»æ¶•", jyutping: "lau4 bei6 tai3"}, { text: "åº·å¾©", jyutping: "hong1 fuk6"}, { text: "å¥åº·", jyutping: "gin1 hong1"}
                ] },
                { id: 6, title: "ç¬¬å…­èª²", words: [{ text: "ç´…è‰²", jyutping: "hung4 sik1" }] },
                { id: 7, title: "ç¬¬ä¸ƒèª²", words: [{ text: "çˆ¸çˆ¸", jyutping: "baa1 baa1" }] },
                { id: 8, title: "ç¬¬å…«èª²", words: [{ text: "ä¸€äºŒä¸‰", jyutping: "yat1 yi6 saam1" }] },
                { id: 9, title: "ç¬¬ä¹èª²", words: [{ text: "å¥½é£Ÿ", jyutping: "hou2 sik6" }] },
                { id: 10, title: "ç¬¬åèª²", words: [{ text: "é¦™æ¸¯", jyutping: "hoeng1 gong2" }] }
            ]
        },
        3: { title: "ç¬¬ä¸‰å†Š", lessons: Array.from({ length: 5 }, (_, i) => ({ id: i + 1, title: `ç¬¬${i + 1}èª²`, words: [ { text: `å•†æ¥­ç”¨èª`, jyutping: "soeng1 yip6" } ] })) },
        4: { title: "ç¬¬å››å†Š", lessons: Array.from({ length: 5 }, (_, i) => ({ id: i + 1, title: `ç¬¬${i + 1}èª²`, words: [ { text: `å£èªè¡¨é”`, jyutping: "hau2 yu5" } ] })) }
    };
    
    // --- æ ¸å¿ƒè®Šæ•¸ ---
    let currentView = 'home';
    let selectedBook = null;
    let selectedLesson = null;
    const contentDiv = document.getElementById('content');
    const headerTitle = document.getElementById('header-title');
    const breadcrumbBook = document.getElementById('breadcrumb-book');
    const breadcrumbLesson = document.getElementById('breadcrumb-lesson');
    let currentAudio = null;

    // --- Google èªéŸ³ ---
    function speakCantonese(text) {
        if (currentAudio) {
            currentAudio.pause();
            currentAudio.currentTime = 0;
        }
        const encodedText = encodeURIComponent(text);
        const url = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodedText}&tl=zh-yue&total=1&idx=0&textlen=${text.length}&client=tw-ob&prev=input&ttsspeed=1`;
        currentAudio = new Audio(url);
        currentAudio.playbackRate = speechSpeed; 
        currentAudio.onerror = function() { alert("æ’­æ”¾å¤±æ•—ã€‚è«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥ã€‚"); };
        currentAudio.play().catch(e => console.error(e));
    }

    window.handlePronunciationRequest = function(text, jyutping, speakText) {
        const textToSpeak = speakText ? speakText : text;
        speakCantonese(textToSpeak);
    }

    // ==========================================
    // â–¼â–¼â–¼ å¯«å­—æ¿ + å¤šå­—åˆ‡æ›é‚è¼¯ â–¼â–¼â–¼
    // ==========================================
    const modal = document.getElementById('writing-modal');
    const canvas = document.getElementById('writing-canvas');
    const ctx = canvas.getContext('2d');
    const charTabsContainer = document.getElementById('char-tabs-container');
    const nextCharBtn = document.getElementById('next-char-btn');
    
    let isDrawing = false;
    let hanziWriterInstance = null;
    let currentWordArr = []; // å­˜æ”¾æ‹†åˆ†å¾Œçš„å­—è© ["ç™¼", "ç‡’"]
    let currentCharIndex = 0; // ç›®å‰é¸ä¸­çš„æ˜¯ç¬¬å¹¾å€‹å­—

    // ç•«ç­†æ¨£å¼
    ctx.lineWidth = 10;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.strokeStyle = 'rgba(37, 99, 235, 0.6)'; 

    window.openWritingModal = function(text) {
        modal.classList.remove('hidden');
        
        // 1. æ‹†åˆ†è©å½™ (å»é™¤æ‹¬è™Ÿ)
        const cleanText = text.split(' ')[0]; 
        currentWordArr = cleanText.split(''); // å°‡ "ç™¼ç‡’" æ‹†æˆ ["ç™¼", "ç‡’"]
        
        // 2. æ¸²æŸ“ä¸Šæ–¹çš„å­—å¡åˆ‡æ›æŒ‰éˆ•
        renderCharTabs();
        
        // 3. é è¨­é¸ä¸­ç¬¬ä¸€å€‹å­—
        selectChar(0);
    }

    function renderCharTabs() {
        charTabsContainer.innerHTML = '';
        currentWordArr.forEach((char, index) => {
            const btn = document.createElement('div');
            btn.className = `char-tab ${index === currentCharIndex ? 'active' : ''}`;
            btn.innerText = char;
            btn.onclick = () => selectChar(index);
            charTabsContainer.appendChild(btn);
        });
    }

    window.selectChar = function(index) {
        currentCharIndex = index;
        
        // æ›´æ–°æŒ‰éˆ•æ¨£å¼
        const tabs = document.querySelectorAll('.char-tab');
        tabs.forEach((tab, i) => {
            if(i === index) tab.classList.add('active');
            else tab.classList.remove('active');
        });

        // é¡¯ç¤º/éš±è—ã€Œä¸‹ä¸€å€‹å­—ã€æŒ‰éˆ•
        if (index < currentWordArr.length - 1) {
            nextCharBtn.classList.remove('hidden');
        } else {
            nextCharBtn.classList.add('hidden');
        }

        // æ¸…é™¤ç•«å¸ƒ
        clearCanvas();
        document.getElementById('hanzi-target').innerHTML = '';

        // è¼‰å…¥ç­†é †å‹•ç•«
        const char = currentWordArr[index];
        hanziWriterInstance = HanziWriter.create('hanzi-target', char, {
            width: 340,
            height: 340,
            padding: 20,
            showOutline: true,
            strokeAnimationSpeed: 1,
            delayBetweenStrokes: 200,
            strokeColor: '#D1D5DB', 
            radicalColor: '#9CA3AF',
            outlineColor: '#E5E7EB',
        });

        hanziWriterInstance.animateCharacter();
    }

    window.nextChar = function() {
        if (currentCharIndex < currentWordArr.length - 1) {
            selectChar(currentCharIndex + 1);
        }
    }

    window.replayAnimation = function() {
        if(hanziWriterInstance) {
            clearCanvas();
            hanziWriterInstance.animateCharacter();
        }
    }

    window.closeWritingModal = function() {
        modal.classList.add('hidden');
    }

    window.clearCanvas = function() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    // --- ç•«ç•«äº‹ä»¶ç›£è½ ---
    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
    }

    function startDraw(e) {
        isDrawing = true;
        const pos = getPos(e);
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
        e.preventDefault(); 
    }

    function draw(e) {
        if (!isDrawing) return;
        const pos = getPos(e);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        e.preventDefault();
    }

    function endDraw() {
        isDrawing = false;
        ctx.beginPath();
    }

    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', endDraw);
    canvas.addEventListener('mouseout', endDraw);
    canvas.addEventListener('touchstart', startDraw, { passive: false });
    canvas.addEventListener('touchmove', draw, { passive: false });
    canvas.addEventListener('touchend', endDraw);

    // --- æ¸²æŸ“å‡½æ•¸ ---
    function renderHome() {
        currentView = 'home';
        selectedBook = null;
        selectedLesson = null;
        headerTitle.textContent = "ç²µèªè©å½™å­¸ç¿’ç³»çµ±";
        breadcrumbBook.classList.add('hidden');
        breadcrumbLesson.classList.add('hidden');
        let html = '<div class="grid grid-cols-2 md:grid-cols-4 gap-4">';
        Object.keys(learningMaterial).forEach(bookId => {
            html += `<button onclick="selectBook(${bookId})" class="p-6 bg-blue-500 text-white font-semibold text-lg rounded-lg shadow-md hover:bg-blue-600 transition duration-150 transform hover:scale-105">${learningMaterial[bookId].title}</button>`;
        });
        html += '</div>';
        contentDiv.innerHTML = html;
    }

    function renderBook() {
        const book = learningMaterial[selectedBook];
        headerTitle.textContent = `${book.title} - é¸æ“‡èª²å ‚`;
        breadcrumbBook.querySelector('span').textContent = book.title;
        breadcrumbBook.classList.remove('hidden');
        breadcrumbLesson.classList.add('hidden');
        let html = '<div class="grid grid-cols-2 md:grid-cols-5 gap-4">';
        book.lessons.forEach(lesson => {
            html += `<button onclick="selectLesson(${lesson.id})" class="p-4 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition duration-150">${lesson.title}</button>`;
        });
        html += '</div>';
        contentDiv.innerHTML = html;
    }

    function renderLesson() {
        const book = learningMaterial[selectedBook];
        const lesson = book.lessons.find(l => l.id === selectedLesson);
        headerTitle.textContent = `${book.title} - ${lesson.title}`;
        breadcrumbLesson.querySelector('span').textContent = lesson.title;
        breadcrumbLesson.classList.remove('hidden');
        
        let html = `
            <div class="mb-6 flex justify-start">
                <button onclick="renderBook()" class="flex items-center space-x-2 px-4 py-2 bg-yellow-500 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-600 transition duration-150">
                    <span>â¬… è¿”å›èª²å ‚åˆ—è¡¨</span>
                </button>
            </div>
            <div class="space-y-4">
        `;
        
        lesson.words.forEach((item) => {
            html += `
                <div class="p-4 bg-gray-100 rounded-lg shadow-inner border-l-4 border-red-500 flex justify-between items-center hover:bg-yellow-50 transition duration-150">
                    <div>
                        <div class="text-3xl font-bold text-gray-800">${item.text}</div>
                        <div class="text-sm text-gray-500 mt-1">${item.jyutping}</div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="handlePronunciationRequest('${item.text}', '${item.jyutping}', '${item.speakText || ''}')" 
                                class="bg-red-500 text-white px-4 py-2 rounded-lg shadow-md hover:bg-red-600 active:scale-95 transition flex items-center">
                            ğŸ”Š <span class="hidden md:inline ml-1">æ’­æ”¾</span>
                        </button>
                        <button onclick="openWritingModal('${item.text}')" 
                                class="bg-blue-500 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-600 active:scale-95 transition flex items-center">
                            ğŸ“ <span class="hidden md:inline ml-1">å¯«å­—</span>
                        </button>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        contentDiv.innerHTML = html;
    }

    window.selectBook = (id) => { selectedBook = id; renderBook(); };
    window.selectLesson = (id) => { selectedLesson = id; renderLesson(); };
    window.renderHome = renderHome;
    window.renderBook = renderBook;
    window.selectChar = selectChar;
    window.nextChar = nextChar;
    window.replayAnimation = replayAnimation;
    window.onload = renderHome;
</script>
</body>
</html>
